import{_ as i,r as c,o as l,c as u,a,b as s,w as o,d as n,e as t}from"./app.ff0cf306.js";const r={},d=a("h1",{id:"transformadores-de-la-api-del-bot",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#transformadores-de-la-api-del-bot","aria-hidden":"true"},"#"),n(" Transformadores de la API del Bot")],-1),m=a("p",null,"El middleware es una funci\xF3n que maneja un objeto de contexto, es decir, datos entrantes.",-1),k=a("p",null,[n("grammY tambi\xE9n le proporciona la inversa. Una "),a("em",null,"funci\xF3n transformadora"),n(" es una funci\xF3n que maneja datos de salida, es decir")],-1),v=a("ul",null,[a("li",null,"un nombre de m\xE9todo de la API del Bot al que llamar."),a("li",null,"un objeto de carga \xFAtil que coincide con el m\xE9todo.")],-1),f=n("En lugar de tener "),b=a("code",null,"next",-1),_=n(" como \xFAltimo argumento para invocar el middleware de salida, se recibe "),h=a("code",null,"prev",-1),g=n(" como primer argumento para utilizar las funciones transformadoras de salida. Mirando la firma de tipo de "),x=a("code",null,"Transformer",-1),y=n(" ("),w={href:"https://doc.deno.land/https://deno.land/x/grammy/mod.ts/~/Transformer",target:"_blank",rel:"noopener noreferrer"},q=n("grammY API Reference"),A=n("), podemos ver c\xF3mo refleja esto. Observa que "),P=a("code",null,[n("Payload<M"),a("wbr"),n(", R>")],-1),j=n(" se refiere al objeto payload que tiene que coincidir con el m\xE9todo dado, y que "),I=a("code",null,[n("Api"),a("wbr"),n("Response<Api"),a("wbr"),n("Call"),a("wbr"),n("Result<M"),a("wbr"),n(", R>>")],-1),C=n(" es el tipo de retorno del m\xE9todo invocado."),L=t(`<p>La \xFAltima funci\xF3n transformadora invocada es un caller incorporado que hace cosas como la serializaci\xF3n JSON de ciertos campos, y eventualmente llama a <code>fetch</code>.</p><p>No hay un equivalente a una clase <code>Composer</code> para las funciones transformadoras porque probablemente sea excesivo, pero si lo necesitas, puedes escribir el tuyo propio. \xA1PR bienvenido! \u{1F609}</p><h2 id="instalar-una-funcion-transformadora" tabindex="-1"><a class="header-anchor" href="#instalar-una-funcion-transformadora" aria-hidden="true">#</a> Instalar una funci\xF3n transformadora</h2><p>Las funciones transformadoras pueden ser instaladas en <code>bot<wbr>.api</code>. Aqu\xED hay un ejemplo para una funci\xF3n transformadora que no hace nada:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// Funci\xF3n transformadora de paso</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">prev</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Comparaci\xF3n con el middleware de paso</span>
bot<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Aqu\xED hay un ejemplo de una funci\xF3n transformadora que evita que se produzcan todas las llamadas a la API:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// Devuelve incorrectamente undefined en lugar de los respectivos tipos de objetos.</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> method<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>Tambi\xE9n puedes instalar funciones transformadoras en el objeto API del objeto de contexto. La funci\xF3n transformadora s\xF3lo se utilizar\xE1 temporalmente para las solicitudes de la API que se realicen en ese objeto de contexto espec\xEDfico. Las llamadas a <code>bot<wbr>.api</code> no se ven afectadas. Las llamadas a trav\xE9s de objetos de contexto de middleware que se ejecutan simult\xE1neamente tampoco se ven afectadas. Tan pronto como el middleware respectivo se completa, la funci\xF3n transformadora se descarta.</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Se instala en todos los objetos de contexto que procesan mensajes.</span>
  ctx<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">prev</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>El par\xE1metro <code>signal</code> debe pasarse siempre a <code>prev</code>. Permite cancelar peticiones y es importante para que <code>bot<wbr>.stop</code> funcione.</p></blockquote><p>Las funciones de transformaci\xF3n instaladas en <code>bot<wbr>.api</code> ser\xE1n preinstaladas en cada objeto <code>ctx<wbr>.api</code>. As\xED, las llamadas a <code>ctx<wbr>.api</code> ser\xE1n transformadas tanto por los transformadores de <code>ctx<wbr>.api</code> como por los transformadores instalados en <code>bot<wbr>.api</code>.</p><h2 id="casos-de-uso-de-las-funciones-de-transformacion" tabindex="-1"><a class="header-anchor" href="#casos-de-uso-de-las-funciones-de-transformacion" aria-hidden="true">#</a> Casos de uso de las funciones de transformaci\xF3n</h2><p>Las funciones transformadoras son tan flexibles como el middleware, y tienen tantas aplicaciones diferentes.</p>`,13),S=n("Por ejemplo, el plugin "),E=n("grammY menu"),M=n(" instala una funci\xF3n transformadora para convertir las instancias de men\xFA salientes en la carga \xFAtil correcta. Tambi\xE9n puedes utilizarlos para:"),T=n("implementar "),F=n("flood control"),R=a("li",null,"simular solicitudes de la API durante las pruebas",-1),B=n("a\xF1adir "),z=n("auto"),N=a("wbr",null,null,-1),Y=n("-retry"),V=t('<p>Ten en cuenta, sin embargo, que reintentar una llamada a la API puede tener efectos secundarios extra\xF1os: si llamas a <code>send<wbr>Document</code> y pasas una instancia de stream legible a <code>Input<wbr>File</code>, entonces el stream ser\xE1 le\xEDdo la primera vez que se intente la petici\xF3n. Si invocas <code>prev</code> de nuevo, el flujo puede estar ya consumido (parcialmente), lo que lleva a archivos rotos. Por lo tanto, es una forma m\xE1s fiable de pasar las rutas de los archivos a <code>Input<wbr>File</code>, para que grammY pueda recrear el flujo cuando sea necesario.</p><h2 id="api-flavoring" tabindex="-1"><a class="header-anchor" href="#api-flavoring" aria-hidden="true">#</a> API Flavoring</h2>',2),U=n("grammY cuenta con "),D=n("context flavors"),O=t(" que pueden ser usados para ajustar el tipo de contexto. Esto incluye los m\xE9todos de la API, tanto los que est\xE1n directamente en el objeto de contexto como <code>ctx<wbr>.reply</code>, y todos los m\xE9todos en <code>ctx<wbr>.api</code> y <code>ctx<wbr>.api<wbr>.raw</code>. Sin embargo, no puedes ajustar los tipos de <code>bot<wbr>.api</code> y <code>bot<wbr>.api<wbr>.raw</code> a trav\xE9s de los context flavors.",11),J=t(`<p>Por eso grammY admite los <em>API flavors</em>. Estos resuelven este problema:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Api<span class="token punctuation">,</span> Bot<span class="token punctuation">,</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;grammy&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SomeApiFlavor<span class="token punctuation">,</span> SomeContextFlavor<span class="token punctuation">,</span> somePlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;some-plugin&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Context flavoring</span>
<span class="token keyword">type</span> <span class="token class-name">MyContext</span> <span class="token operator">=</span> Context <span class="token operator">&amp;</span> SomeContextFlavor<span class="token punctuation">;</span>
<span class="token comment">// API flavoring</span>
<span class="token keyword">type</span> <span class="token class-name">MyApi</span> <span class="token operator">=</span> Api <span class="token operator">&amp;</span> SomeApiFlavor<span class="token punctuation">;</span>

<span class="token comment">// Usa ambos flavors.</span>
<span class="token keyword">const</span> bot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bot<span class="token operator">&lt;</span>MyContext<span class="token punctuation">,</span> MyApi<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;my-token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Usa un plugin.</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">somePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Ahora llama a \`bot.api\` con los tipos ajustados del API flavor.</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">somePluginMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Tambi\xE9n, usa el tipo de contexto ajustado del context flavor.</span>
bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">somePluginMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),G=n("API flavors funcionan exactamente igual que los tipos de context flavors. Existen API flavors aditivos y transformativos, y se pueden combinar m\xFAltiples API flavors de la misma manera que se har\xEDa con context flavors. Si no est\xE1s seguro de c\xF3mo funciona esto, vuelve a la "),H=n("secci\xF3n sobre context flavors"),K=n(" en la gu\xEDa.");function Q(W,X){const p=c("ExternalLinkIcon"),e=c("RouterLink");return l(),u("div",null,[d,m,k,v,a("p",null,[f,b,_,h,g,x,y,a("a",w,[q,s(p)]),A,P,j,I,C]),L,a("p",null,[S,s(e,{to:"/es/plugins/menu.html"},{default:o(()=>[E]),_:1}),M]),a("ul",null,[a("li",null,[T,s(e,{to:"/es/plugins/transformer-throttler.html"},{default:o(()=>[F]),_:1})]),R,a("li",null,[B,s(e,{to:"/es/plugins/auto-retry.html"},{default:o(()=>[z,N,Y]),_:1})])]),V,a("p",null,[U,s(e,{to:"/es/guide/context.html#context-flavors"},{default:o(()=>[D]),_:1}),O]),J,a("p",null,[G,s(e,{to:"/es/guide/context.html#context-flavors"},{default:o(()=>[H]),_:1}),K])])}const $=i(r,[["render",Q],["__file","transformers.html.vue"]]);export{$ as default};
